name: Branch Sync Monitor

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

jobs:
  check-sync-status:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check branch sync status
        run: |
          echo "## Branch Sync Status Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check docs branch sync
          DOCS_BEHIND=$(git rev-list --count origin/docs..origin/main -- apps/docs/)
          echo "| Branch | Status | Commits Behind | Notes |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|----------------|-------|" >> $GITHUB_STEP_SUMMARY
          
          if [ $DOCS_BEHIND -eq 0 ]; then
            echo "| docs | âœ… Synced | 0 | Documentation up to date |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| docs | âš ï¸ Behind | $DOCS_BEHIND | Documentation needs update |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check gh-pages branch sync
          GHPAGES_BEHIND=$(git rev-list --count origin/gh-pages..origin/main -- packages/ tools/build/ cdn/)
          if [ $GHPAGES_BEHIND -eq 0 ]; then
            echo "| gh-pages | âœ… Synced | 0 | CDN assets up to date |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| gh-pages | âš ï¸ Behind | $GHPAGES_BEHIND | CDN assets need update |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check last deployment times
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Last Deployment Times" >> $GITHUB_STEP_SUMMARY
          echo "- **Documentation**: $(git log -1 --format='%ci' origin/docs)" >> $GITHUB_STEP_SUMMARY
          echo "- **CDN Assets**: $(git log -1 --format='%ci' origin/gh-pages)" >> $GITHUB_STEP_SUMMARY
          
          # Auto-trigger deployments if needed
          if [ $DOCS_BEHIND -gt 0 ]; then
            echo "ðŸ”„ Triggering documentation deployment..." >> $GITHUB_STEP_SUMMARY
            gh workflow run deploy-docs.yml --repo ${{ github.repository }}
          fi
          
          if [ $GHPAGES_BEHIND -gt 0 ]; then
            echo "ðŸ”„ Triggering CDN deployment..." >> $GITHUB_STEP_SUMMARY
            gh workflow run cdn-deploy.yml --repo ${{ github.repository }}
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}